---
######################
#   Install Sliver   #
######################
- name: Include Go installation tasks
  include_tasks: install_go.yml

- name: Ensure /tmp/sliver-src directory is absent
  file:
    path: /tmp/sliver-src
    state: absent

- name: Ensure sliver install path exists
  file:
    path: "{{ sliver_install_path }}"
    state: directory
    mode: '0755'
    
- name: Determine Sliver version to use
  set_fact:
    sliver_version_resolved: "{{ sliver_version }}"
  when: sliver_version not in ['stable', 'latest']

- name: Get latest stable Sliver tag
  shell: |
    git ls-remote --tags --sort="v:refname" https://github.com/BishopFox/sliver | grep '\^{}' | tail -n1 | sed 's/.*refs\/tags\///;s/\^{}//'
  register: sliver_latest_tag
  when: sliver_version == 'stable'
  changed_when: false

- name: Set resolved version to latest stable tag
  set_fact:
    sliver_version_resolved: "{{ sliver_latest_tag.stdout }}"
  when: sliver_version == 'stable'

- name: Set resolved version to master for latest
  set_fact:
    sliver_version_resolved: "master"
  when: sliver_version == 'latest'

- name: Clone Sliver repository
  git:
    repo: "{{ sliver_repo_url }}"
    dest: /tmp/sliver-src
    version: "{{ sliver_version_resolved }}"
    force: yes

- name: Download Go modules
  shell: |
    cd /tmp/sliver-src
    go mod download

- name: Build Sliver
  shell: |
    set -o pipefail
    make 2>&1 | tee /tmp/sliver_build_attempt1.log || true
  args:
    chdir: /tmp/sliver-src
  register: sliver_build

- name: Fail if build failed
  fail:
    msg: "Sliver build failed"
  when: sliver_build.rc != 0

- name: Find sliver-server binary
  find:
    paths: /tmp/sliver-src
    patterns: 'sliver-server*'
    file_type: file
    recurse: no
  register: sliver_server_binary

- name: Find sliver-client binary
  find:
    paths: /tmp/sliver-src
    patterns: 'sliver-client*'
    file_type: file
    recurse: no
  register: sliver_client_binary

- name: Debug - Show found binaries
  debug:
    msg: |
      Server binary: {{ sliver_server_binary.files | map(attribute='path') | list }}
      Client binary: {{ sliver_client_binary.files | map(attribute='path') | list }}

- name: Fail if server binary not found
  fail:
    msg: "sliver-server binary not found after build"
  when: sliver_server_binary.files | length == 0

- name: Fail if client binary not found
  fail:
    msg: "sliver-client binary not found after build"
  when: sliver_client_binary.files | length == 0

- name: Copy sliver-server binary
  copy:
    src: "{{ sliver_server_binary.files[0].path }}"
    dest: "{{ sliver_install_path }}/sliver-server"
    mode: '0755'
    remote_src: yes

- name: Copy sliver-client binary
  copy:
    src: "{{ sliver_client_binary.files[0].path }}"
    dest: "{{ sliver_install_path }}/sliver-client"
    mode: '0755'
    remote_src: yes

- name: Create systemd service for Sliver (optional)
  when: sliver_create_service
  template:
    src: sliver-server.service.j2
    dest: /etc/systemd/system/{{ sliver_service_name }}.service
    mode: '0644'
  notify: Restart Sliver

- name: Copy Sliver configuration files if present
  copy:
    src: "{{ item }}"
    dest: "/root/.sliver/{{ item | basename }}"
    owner: root
    group: root
    mode: '0600'
  with_fileglob:
    - "{{ role_path }}/files/*.yaml"
    - "{{ role_path }}/files/*.yml"
    - "{{ role_path }}/files/*.json"
  when: (lookup('fileglob', role_path + '/files/*.yaml', errors='ignore') | length > 0) or
        (lookup('fileglob', role_path + '/files/*.yml', errors='ignore') | length > 0) or
        (lookup('fileglob', role_path + '/files/*.json', errors='ignore') | length > 0)

- name: Configure operator configs
  ansible.builtin.include_tasks: configure_operators.yml
  when: sliver_generate_operator_configs | bool

- name: Install Sliver implant generator
  include_tasks: install_implant_generator.yml
  when: sliver_install_implant_generator | bool

- name: Clean up build directory
  file:
    path: /tmp/sliver-src
    state: absent  
